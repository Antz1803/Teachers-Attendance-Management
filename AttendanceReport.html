<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/AttendanceReport.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <div class="profile-container">
            <div class="profile-circle">
                <i class="fas fa-user-tie"></i> </div>
            <div class="profile-info">
                <h3>Admin</h3>
                <span>Authorized</span>
            </div>
        </div>
    </div>

    <ul class="nav-links">
        <li class="nav-item active">
            <a href="Dashboard.html"><i class="fas fa-chart-line"></i> Attendance Report</a>
        </li>
        <li class="nav-item">
            <a href="Users.html"><i class="fas fa-users"></i> Users</a>
        </li>
        <li class="nav-item">
            <a href="Courses.html"><i class="fas fa-book"></i> Courses</a>
        </li>
        <li class="nav-item">
            <a href="Settings.html"><i class="fas fa-cog"></i> Settings</a>
        </li>
    </ul>

    <div class="sidebar-footer">
        <li class="nav-item logout">
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </li>
    </div>
</div>

    <div class="main-content">
        <header>
            <h1>Attendance Report</h1>
            <div class="menu-container">
                <button class="menu-button" onclick="toggleMenu()">
                    &#9776;
                </button>
        
                <div id="myDropdown" class="dropdown-menu">
                    <a href="AttendanceManagement.html" class="active-link">Attendance Management</a>
                    <a href="AttendanceReport.html">Attendance Report</a>
                </div>
            </div>
        </header>

      <div class="filters">
    <div class="filter-group">
        <label>Courses</label>
        <select id="courseFilter">
            <option value="all">All Courses</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Date Range</label>
        <select id="dateFilter">
            <option value="all">All Time</option>
            <option value="weekly">This Week</option>
            <option value="monthly">This Month</option>
        </select>
    </div>
    <button class="btn-generate">Generate</button>
</div>

      <div class="summary-bar">
    <div class="summary-item">
        <div class="summary-label label-total">Total Students</div>
        <div class="summary-value" id="totalStudentsCount">0</div>
    </div>
    <div class="summary-item" style="border-left: 2px solid var(--teal-primary); border-right: 2px solid var(--teal-primary);">
        <div class="summary-label label-present">Avg. Present</div>
        <div class="summary-value" id="avgPresentCount">0</div>
    </div>
    <div class="summary-item">
        <div class="summary-label label-absent">Avg. Absent</div>
        <div class="summary-value" id="avgAbsentCount">0</div>
    </div>
</div>

<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Student ID</th>
                <th>Total Classes</th>
                <th>Days Present</th>
                <th>Attendance Rate</th>
            </tr>
        </thead>
        <tbody id="reportTableBody">
            <tr><td colspan="5" style="text-align:center;">Select filters and click Generate</td></tr>
        </tbody>
    </table>
</div>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, get } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
        authDomain: "attendancesystem-cb683.firebaseapp.com",
        databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
        projectId: "attendancesystem-cb683",
        storageBucket: "attendancesystem-cb683.appspot.com",
        messagingSenderId: "975901701661",
        appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // IMPORTANT: Check if user is logged in first (because of your Rules)
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Authenticated: Fetching filters...");
            populateFilters();
        } else {
            console.warn("User not logged in. Redirecting...");
            window.location.href = "index.html"; 
        }
    });

    async function populateFilters() {
        const attendanceRef = ref(db, 'attendance');
        const snapshot = await get(attendanceRef);
        if (!snapshot.exists()) return;

        const allData = snapshot.val();
        const courses = new Set();

        Object.values(allData).forEach(dayNode => {
            Object.values(dayNode).forEach(record => {
                // Matches your .indexOn ["course"]
                if (record.course) courses.add(record.course);
            });
        });

        const courseSelect = document.getElementById('courseFilter');
        courses.forEach(course => {
            const opt = document.createElement('option');
            opt.value = course;
            opt.textContent = course;
            courseSelect.appendChild(opt);
        });
    }

    async function generateReport() {
        const selectedCourse = document.getElementById('courseFilter').value;
        const selectedRange = document.getElementById('dateFilter').value;
        const tbody = document.getElementById('reportTableBody');
        
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Analyzing Records...</td></tr>';

        const snapshot = await get(ref(db, 'attendance'));
        if (!snapshot.exists()) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No attendance history found.</td></tr>';
            return;
        }

        const allDates = snapshot.val();
        const studentStats = {};
        const now = new Date();

        Object.keys(allDates).forEach(dateStr => {
            const recordDate = new Date(dateStr);
            const diffDays = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));

            if (selectedRange === 'weekly' && diffDays > 7) return;
            if (selectedRange === 'monthly' && diffDays > 30) return;

            const dayRecords = allDates[dateStr];
            Object.values(dayRecords).forEach(record => {
                if (selectedCourse !== 'all' && record.course !== selectedCourse) return;

                const id = record.studentID; 
                if (!studentStats[id]) {
                    studentStats[id] = {
                        name: record.name,
                        presentCount: 0,
                        totalDays: 0
                    };
                }
                
                studentStats[id].totalDays++;
                if (record.status === "PRESENT" || record.status === "LATE") {
                    studentStats[id].presentCount++;
                }
            });
        });

        renderTable(studentStats);
    }

    function renderTable(stats) {
        const tbody = document.getElementById('reportTableBody');
        let html = '';
        let totalStudents = 0, grandPresent = 0, totalDaysCount = 0;

        Object.keys(stats).forEach(id => {
            const s = stats[id];
            const rate = ((s.presentCount / s.totalDays) * 100).toFixed(1);
            totalStudents++;
            grandPresent += s.presentCount;
            totalDaysCount += s.totalDays;

            html += `<tr>
                <td>${s.name}</td>
                <td>${id}</td>
                <td class="val-blue">${s.totalDays}</td>
                <td class="val-blue">${s.presentCount}</td>
                <td class="val-blue">${rate}%</td>
            </tr>`;
        });

        tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No records found.</td></tr>';
        
        document.getElementById('totalStudentsCount').textContent = totalStudents;
        document.getElementById('avgPresentCount').textContent = totalStudents > 0 ? Math.round(grandPresent / totalStudents) : 0;
        document.getElementById('avgAbsentCount').textContent = totalStudents > 0 ? Math.round((totalDaysCount - grandPresent) / totalStudents) : 0;
    }

    document.querySelector('.btn-generate').onclick = generateReport;
    window.toggleMenu = () => document.getElementById("myDropdown").classList.toggle("show");
</script>
</body>

</html>


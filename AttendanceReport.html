<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/Dashboard.css">
    <link rel="stylesheet" href="StyleSheet/AttendanceReport.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
     <style>
        /* Toast Notification - Upper Right */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { 
            padding: 12px 20px; border-radius: 8px; color: #fff; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; font-family: sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards;
        }
        .success { background: #008080; }
        .error { background: #e74c3c; }
        .info { background: #3498db; }

        /* Custom Logout Modal */
        .logout-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); 
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 350px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        .modal-btns { display: flex; gap: 15px; margin-top: 20px; }
        
        .btn-confirm { 
            background: #e74c3c; color: white; flex: 1; padding: 12px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        /* Interactive Shake Animation */
        .btn-confirm:hover { 
            background: #c0392b; 
            animation: shake 0.5s ease; 
        }
        .btn-cancel { background: #f0f0f0; flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
    </style>
</head>
<body style="display: flex; margin: 0; background-color: #f4f7f6;">
    <div id="sidebar-placeholder" style="width: 240px; min-height: 100vh; background: #008080;"></div>

    <div id="logoutModal" class="logout-modal">
        <div class="modal-content">
            <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #e74c3c;"></i>
            <h3>Ready to Leave?</h3>
            <p>Confirm if you want to log out of your admin session.</p>
            <div class="modal-btns">
                <button class="btn-confirm" id="confirmLogout">Yes, Log out</button>
                <button class="btn-cancel" onclick="closeLogoutModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="main-content" style="flex-grow: 1; height: 100vh; overflow-y: auto;">
        <header class="top-header">
            <h1 style="font-weight: bold;">Attendance Report</h1>
            <div class="menu-container">
                <button class="menu-button" onclick="toggleMenu()">&#9776;</button>
                <div id="myDropdown" class="dropdown-menu">
                    <a href="AttendanceManagement.html">Attendance Management</a>
                    <a href="AttendanceReport.html" class="active-link">Attendance Report</a>
                </div>
            </div>
        </header>

        <div class="filters">
            <div class="filter-group">
                <label>Courses</label>
                <select id="courseFilter">
                    <option value="all">All Courses</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date Range</label>
                <select id="dateFilter">
                    <option value="all">All Time</option>
                    <option value="weekly">This Week</option>
                    <option value="monthly">This Month</option>
                </select>
            </div>
        </div>

        <div class="summary-bar">
            <div class="summary-item">
                <div class="summary-label label-total">Total Students</div>
                <div class="summary-value" id="totalStudentsCount">0</div>
            </div>
            <div class="summary-item" style="border-left: 2px solid #008080; border-right: 2px solid #008080;">
                <div class="summary-label label-present">Avg. Present</div>
                <div class="summary-value" id="avgPresentCount">0</div>
            </div>
            <div class="summary-item">
                <div class="summary-label label-absent">Avg. Absent</div>
                <div class="summary-value" id="avgAbsentCount">0</div>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Student ID</th>
                        <th>Total Classes</th>
                        <th>Days Present</th>
                        <th>Attendance Rate</th>
                    </tr>
                </thead>
                <tbody id="reportTableBody">
                    <tr><td colspan="5" style="text-align:center;">Select filters and click Generate</td></tr>
                </tbody>
            </table>
        </div>
    </div>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, get, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
        authDomain: "attendancesystem-cb683.firebaseapp.com",
        databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
        projectId: "attendancesystem-cb683",
        storageBucket: "attendancesystem-cb683.appspot.com",
        messagingSenderId: "975901701661",
        appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- SIDEBAR LOADER ---
    async function loadSidebar() {
        try {
            const response = await fetch('SideBar.html');
            const html = await response.text();
            document.getElementById('sidebar-placeholder').innerHTML = html;

            const currentPage = window.location.pathname.split("/").pop();
            document.querySelectorAll('.nav-item').forEach(item => {
                const link = item.querySelector('a');
                if (link && link.getAttribute('href') === currentPage) {
                    item.classList.add('active');
                }
            });

            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('logoutModal').style.display = 'flex';
                });
            }
        } catch (err) { console.error("Sidebar error:", err); }
    }

    // --- AUTH & PROFILE ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            populateFilters();
            const userRef = ref(db, 'users/' + user.uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data && document.getElementById('sidebarName')) {
                    document.getElementById('sidebarName').textContent = data.fullName || "Admin";
                    document.getElementById('sidebarRole').textContent = data.role || "Teacher";
                    const container = document.getElementById('profileContainer');
                    if (container) {
                        container.innerHTML = (data.profilePic && data.profilePic !== "avatar.png") 
                            ? `<img src="${data.profilePic}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`
                            : `<i class="fas fa-user-tie"></i>`;
                    }
                }
            });
        } else {
            window.location.href = 'index.html';
        }
    });

    window.closeLogoutModal = () => document.getElementById('logoutModal').style.display = 'none';
    document.getElementById('confirmLogout').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = 'index.html');
    });

    // --- AUTOMATIC REPORT LOGIC ---
    async function populateFilters() {
        const studentRef = ref(db, 'students');
        const snapshot = await get(studentRef);
        if (!snapshot.exists()) return;

        const courses = new Set();
        snapshot.forEach(child => {
            if (child.val().stuCourses) courses.add(child.val().stuCourses);
        });

        const courseSelect = document.getElementById('courseFilter');
        courses.forEach(course => {
            const opt = document.createElement('option');
            opt.value = course;
            opt.textContent = course;
            courseSelect.appendChild(opt);
        });
    }

    window.generateReport = async function() {
        const selectedCourse = document.getElementById('courseFilter').value;
        const selectedRange = document.getElementById('dateFilter').value;
        const tbody = document.getElementById('reportTableBody');
        
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Analyzing Records...</td></tr>';

        const snapshot = await get(ref(db, 'attendance'));
        if (!snapshot.exists()) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No records found.</td></tr>';
            return;
        }

        const allDates = snapshot.val();
        const studentStats = {};
        const now = new Date();

        Object.keys(allDates).forEach(dateStr => {
            const recordDate = new Date(dateStr);
            const diffDays = Math.floor((now - recordDate) / (1000 * 60 * 60 * 24));

            // Logic to skip dates outside the filter range
            if (selectedRange === 'weekly' && diffDays > 7) return;
            if (selectedRange === 'monthly' && diffDays > 30) return;

            Object.values(allDates[dateStr]).forEach(record => {
                if (selectedCourse !== 'all' && record.course !== selectedCourse) return;

                const id = record.studentID;
                if (!studentStats[id]) {
                    studentStats[id] = { name: record.name, presentCount: 0, totalDays: 0 };
                }
                studentStats[id].totalDays++;
                if (record.status === "PRESENT" || record.status === "LATE") {
                    studentStats[id].presentCount++;
                }
            });
        });

        renderTable(studentStats);
    };

    function renderTable(stats) {
        const tbody = document.getElementById('reportTableBody');
        let html = '';
        let totalStudents = 0, grandPresent = 0, totalDaysCount = 0;

        Object.keys(stats).forEach(id => {
            const s = stats[id];
            const rate = ((s.presentCount / s.totalDays) * 100).toFixed(1);
            totalStudents++;
            grandPresent += s.presentCount;
            totalDaysCount += s.totalDays;

            html += `<tr>
                <td>${s.name}</td>
                <td>${id}</td>
                <td>${s.totalDays}</td>
                <td>${s.presentCount}</td>
                <td style="font-weight:bold; color:#008080;">${rate}%</td>
            </tr>`;
        });

        tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center;">No records matching filters.</td></tr>';
        document.getElementById('totalStudentsCount').textContent = totalStudents;
        document.getElementById('avgPresentCount').textContent = totalStudents > 0 ? Math.round(grandPresent / totalStudents) : 0;
        document.getElementById('avgAbsentCount').textContent = totalStudents > 0 ? Math.round((totalDaysCount - grandPresent) / totalStudents) : 0;
    }

    // --- EVENT LISTENERS FOR AUTO-GENERATION ---
    document.getElementById('dateFilter').onchange = () => {
        window.generateReport();
    };

    document.getElementById('courseFilter').onchange = () => {
        window.generateReport();
    };

    document.querySelector('.btn-generate').onclick = window.generateReport;
    window.toggleMenu = () => document.getElementById("myDropdown").classList.toggle("show");
    
    // Init Sidebar
    loadSidebar();
</script>
</body>

</html>

















<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Management Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/Dashboard.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
    <style>
        /* Toast Notification - Upper Right */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { 
            padding: 12px 20px; border-radius: 8px; color: #fff; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; font-family: sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards;
        }
        .success { background: #008080; }
        .error { background: #e74c3c; }
        .info { background: #3498db; }

        /* Custom Logout Modal */
        .logout-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); 
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 350px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        .modal-btns { display: flex; gap: 15px; margin-top: 20px; }
        
        .btn-confirm { 
            background: #e74c3c; color: white; flex: 1; padding: 12px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        /* Interactive Shake Animation */
        .btn-confirm:hover { 
            background: #c0392b; 
            animation: shake 0.5s ease; 
        }
        .btn-cancel { background: #f0f0f0; flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
    </style>
</head>
<body style="display: flex;">

<div id="toast-container"></div>

<div id="logoutModal" class="logout-modal">
    <div class="modal-content">
        <i class="fas fa-sign-out-alt" style="font-size: 3rem; color: #e74c3c;"></i>
        <h3>Ready to Leave?</h3>
        <p>Confirm if you want to log out of your admin session.</p>
        <div class="modal-btns">
            <button class="btn-confirm" id="confirmLogout">Yes, Log out</button>
            <button class="btn-cancel" onclick="closeLogoutModal()">Cancel</button>
        </div>
    </div>
</div>

<div id="sidebar-placeholder"></div>

<div class="main-content">
<header class="top-header">
    <div class="header-left">
        <h1>DASHBOARD</h1>
    </div>

    <div class="header-center">
        <div id="liveClock">Loading time...</div>
    </div>
    
    <div class="header-right">
        <div class="menu-container">
            <button class="menu-button" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <div id="myDropdown" class="dropdown-menu">
                <a href="AttendanceManagement.html">Attendance Management</a>
                <a href="AttendanceReport.html">Attendance Report</a>
            </div>
        </div>
    </div>
</header>

    <div class="stats-container">
        <div class="card"><h2>Late</h2><p id="lateCount">0</p></div>
        <div class="card"><h2>Absent</h2><p id="absentCount">0</p></div>
        <div class="card"><h2>Present</h2><p id="presentCount">0</p></div>
    </div>

    <div class="table-container">
        <div class="table-header">Student List</div>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Student ID</th>
                    <th>Year Level</th>
                    <th>Section</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <tr><td colspan="6" style="text-align:center;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
        authDomain: "attendancesystem-cb683.firebaseapp.com",
        databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
        projectId: "attendancesystem-cb683",
        storageBucket: "attendancesystem-cb683.appspot.com",
        messagingSenderId: "975901701661",
        appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // --- SIDEBAR LOADER ---
    async function loadSidebar() {
    try {
        const response = await fetch('SideBar.html');
        if (!response.ok) throw new Error("Failed to fetch sidebar");
        const html = await response.text();
        document.getElementById('sidebar-placeholder').innerHTML = html;

        // Get the current file name accurately
        const path = window.location.pathname;
        const currentPage = path.split("/").pop() || "index.html";

        // Remove 'active' from all first, then add to the specific one
        const navLinks = document.querySelectorAll('.nav-links a');
        navLinks.forEach(link => {
            const linkHref = link.getAttribute('href');
            
            // Remove active class from parent nav-item to be safe
            link.parentElement.classList.remove('active');

            // Exact match check
            if (linkHref === currentPage) {
                link.parentElement.classList.add('active');
            }
        });

        // Re-bind logout
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('logoutModal').style.display = 'flex';
        });

    } catch (error) {
        console.error("Sidebar Error:", error);
    }
}
    
    // --- AUTH & PROFILE LOGIC ---
    function startAuthObserver() {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userRef = ref(db, 'users/' + user.uid);
                onValue(userRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
         
                        document.getElementById('sidebarName').textContent = data.fullName || "Admin";
                        document.getElementById('sidebarRole').textContent = data.role || "Authorized";

                        const container = document.getElementById('profileContainer');
                        if (data.profilePic && data.profilePic !== "avatar.png" && data.profilePic !== "N/A") {
                            container.innerHTML = `<img src="${data.profilePic}" id="display-photo" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                        } else {
                            container.innerHTML = `<i class="fas fa-user-tie"></i>`;
                        }
                    }
                });
            } else {
                window.location.href = 'index.html';
            }
        });
    }

    // --- UTILITIES & DATA ---
    const notify = (msg, type = 'success') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<i class="fas fa-${type === 'info' ? 'info' : (type === 'success' ? 'check' : 'exclamation')}-circle"></i> ${msg}`;
        document.getElementById('toast-container').appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    };

    window.closeLogoutModal = () => document.getElementById('logoutModal').style.display = 'none';

    document.getElementById('confirmLogout').addEventListener('click', () => {
        closeLogoutModal();
        notify("Logging out Redirecting...", "info");
        signOut(auth).then(() => {
            window.location.href = 'index.html';
        }).catch(err => notify(err.message, "error"));
    });

  function loadTodayAttendance() {
        // Formats date as YYYY-MM-DD to match common Firebase keys
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const today = `${year}-${month}-${day}`;

        console.log("Fetching attendance for:", today);

        const attendanceRef = ref(db, `attendance/${today}`);
        
        onValue(attendanceRef, (snap) => {
            const tbody = document.getElementById('studentTableBody');
            const lateEl = document.getElementById('lateCount');
            const absentEl = document.getElementById('absentCount');
            const presentEl = document.getElementById('presentCount');
            
            let [l, a, p] = [0, 0, 0];
            
            if (snap.exists()) {
                let html = '';
                const data = snap.val();
                
                // Iterating through student records under today's date
                Object.values(data).forEach(record => {
                    const status = (record.status || "ABSENT").toUpperCase();
                    
                    // Update counters
                    if (status === "PRESENT") p++; 
                    else if (status === "LATE") l++; 
                    else a++;

                    html += `
                        <tr>
                            <td>${record.name || 'Unknown'}</td>
                            <td>${record.email || 'N/A'}</td>
                            <td>${record.studentID || 'N/A'}</td>
                            <td>${record.yearLevel || 'N/A'}</td>
                            <td>${record.section || 'N/A'}</td>
                            <td><span class="status-${status.toLowerCase()}">${status}</span></td>
                        </tr>`;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 20px;">No attendance has been recorded yet for today (${today}).</td></tr>`;
            }

            // Update UI Cards
            lateEl.textContent = l;
            absentEl.textContent = a;
            presentEl.textContent = p;
        }, (error) => {
            console.error("Firebase Read Error:", error);
            notify("Failed to load today's data", "error");
        });
    }

    function startLiveClock() {
        const el = document.getElementById('liveClock');
        setInterval(() => {
            const now = new Date();
            el.innerHTML = `${now.toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'long', day:'numeric'})} | ${now.toLocaleTimeString()}`;
        }, 1000);
    }

    // --- THE MASTER INITIALIZER ---
    async function initializeDashboard() {
        await loadSidebar();     
        startAuthObserver();      
        loadTodayAttendance();   
        startLiveClock();       
    }

    initializeDashboard();
    
    // Globally expose dropdown toggle
    window.toggleMenu = () => document.getElementById("myDropdown").classList.toggle("show");
</script>
</body>
</html>



















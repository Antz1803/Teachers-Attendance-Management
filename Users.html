<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/Dashboard.css"> 
    <link rel="stylesheet" href="StyleSheet/Users.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
</head>
<body style="display: flex; margin: 0;"> <div class="sidebar">
        <div class="sidebar-header">
            <div class="profile-container">
                <div class="profile-circle">
                    <i class="fas fa-user-tie"></i> 
                </div>
                <div class="profile-info">
                    <h3>Admin</h3>
                    <span>Authorized</span>
                </div>
            </div>
        </div>

        <ul class="nav-links">
            <li class="nav-item">
                <a href="Dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
            </li>
            <li class="nav-item active"> 
                <a href="Users.html"><i class="fas fa-users"></i> Users</a>
            </li>
            <li class="nav-item">
                <a href="Courses.html"><i class="fas fa-book"></i> Courses</a>
            </li>
            <li class="nav-item">
                <a href="Settings.html"><i class="fas fa-cog"></i> Settings</a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <li class="nav-item logout">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </div>
    </div>
    
      <div class="main-content">
        <header class="top-header">
            <h1>Users</h1>       
        </header>

        <div class="controls-row">
            <button class="btn-add-student" onclick="openModal()">+ Student</button>
        </div>

     <h3 class="admin-label">Hello! <span id="display-admin-name">Loading...</span></h3>

<div class="profile-card">
    <div class="card-glow"></div>
    
    <div class="card-content">
        <div class="card-header-wrapper">
            <h2 class="card-title">Teacher's Profile</h2>
            <div class="status-badge" id="display-status-badge">ACTIVE</div>
        </div>
        
        <div class="profile-details">
            <div class="detail-item">
                <i class="fas fa-user"></i>
                <div>
                    <strong>Name</strong>
                    <span id="display-name">Loading...</span>
                </div>
            </div>
            <div class="detail-item">
                <i class="fas fa-calendar-alt"></i>
                <div>
                    <strong>Birthdate</strong>
                    <span id="display-birthdate">Loading...</span>
                </div>
            </div>
            <div class="detail-item">
                <i class="fas fa-envelope"></i>
                <div>
                    <strong>Email</strong>
                    <span id="display-email">Loading...</span>
                </div>
            </div>
            <div class="detail-item">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <strong>Address</strong>
                    <span id="display-address">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="photo-column">
        <div class="profile-photo-container">
            <img src="avatar.png" id="display-photo" alt="Profile Photo">
        </div>
        <button class="btn-edit-profile" onclick="openEditModal()">
            <i class="fas fa-edit"></i> Edit profile
        </button>
    </div>
</div>

<div id="editProfileModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
       <div class="modal-body">
            <h3 class="full-width">Update Teacher Profile</h3>
            <div class="file-input-wrapper">
                <img id="edit-preview" src="avatar.png" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                <label for="editPhoto" class="btn-upload">Choose New Photo</label>
                <input type="file" id="editPhoto" accept="image/*" onchange="previewImage(event)">
            </div>
            <div class="modal-grid">
                <div class="modal-form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName">
                </div>
                <div class="modal-form-group">
                    <label>Email Address</label>
                    <input type="email" id="editEmail">
                </div>
                <div class="modal-form-group">
                    <label>Age</label>
                    <input type="text" id="editAge">
                </div>
                <div class="modal-form-group">
                    <label>Birthdate</label>
                    <input type="date" id="editBirthdate">
                </div>
                <div class="modal-form-group">
                    <label>Gender</label>
                    <select id="editGender">
                        <option value="MALE">MALE</option>
                        <option value="FEMALE">FEMALE</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="SINGLE">SINGLE</option>
                        <option value="MARRIED">MARRIED</option>
                        <option value="WIDOWED">WIDOWED</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label>Birthplace</label>
                    <input type="text" id="editBirthplace">
                </div>
                <div class="modal-form-group">
                    <label>Nationality</label>
                    <input type="text" id="editNationality">
                </div>
                <div class="modal-form-group full-width">
                    <label>Current Address</label>
                    <input type="text" id="editAddress">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-submit" id="saveBtn" onclick="saveProfile()">Save Changes</button>
                <button class="btn-clear" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
    
    <div id="studentModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header"></div>
            <div class="modal-body">
                <h3>New Student Details</h3>
                
                <div class="modal-form-group">
                    <label>Full Name</label>
                    <input type="text" id="stuName" placeholder="Please enter your fullname">
                    <small id="error-name" class="error-msg" style="color: red; display: none;">❌ This name is already registered.</small>
                </div>

                <div class="modal-form-group">
                    <label>Email</label>
                    <input type="email" id="stuEmail" placeholder="Please enter your email">
                    <small id="error-email" class="error-msg">❌ Email must end with @gmail.com</small>
                </div>

                <div class="modal-form-group">
                    <label>Student ID</label>
                    <input type="text" id="stuID" placeholder="Please enter your ID" maxlength="10">
                    <small id="error-id" class="error-msg">❌ This Student ID is already registered.</small>
                </div>

                 <div class="modal-form-group">
                    <label>Courses</label>
                    <input type="text" id="stuCourse" placeholder="Please enter your course">
                </div>

                <div class="modal-form-group" style="margin-bottom: 15px;">
                    <label>Year lvl</label>
                    <select id="stuYear" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="" disabled selected>Select Year Level</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label>Section</label>
                    <input type="text" id="stuSection" placeholder="e.g. A">
                </div>

                <div class="modal-footer">
                    <button class="btn-submit" onclick="submitStudent()">Submit</button>
                    <button class="btn-clear" onclick="clearForm()">Clear</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, get, query, orderByChild, equalTo, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
        import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
            authDomain: "attendancesystem-cb683.firebaseapp.com",
            databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
            projectId: "attendancesystem-cb683",
            storageBucket: "attendancesystem-cb683.appspot.com",
            messagingSenderId: "975901701661",
            appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // Preview local image
        window.previewImage = (event) => {
            const reader = new FileReader();
            reader.onload = () => { document.getElementById('edit-preview').src = reader.result; };
            if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snapshot = await get(ref(db, 'users/' + user.uid));
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    document.getElementById('display-admin-name').innerText = data.fullName || "Admin";
                    document.getElementById('display-name').innerText = data.fullName || "N/A";
                    document.getElementById('display-age').innerText = data.age || "N/A";
                    document.getElementById('display-birthdate').innerText = data.birthdate || "N/A";
                    document.getElementById('display-gender').innerText = data.gender || "N/A";
                    document.getElementById('display-email').innerText = data.email || user.email;
                    document.getElementById('display-birthplace').innerText = data.birthplace || "N/A";
                    document.getElementById('display-address').innerText = data.currentAddress || "N/A";
                    document.getElementById('display-nationality').innerText = data.nationality || "N/A";
                    document.getElementById('display-status').innerText = data.status || "N/A";
                    if (data.profilePic) document.getElementById('display-photo').src = data.profilePic;
                }
            } else { window.location.href = 'index.html'; }
        });

        window.openEditModal = async () => {
            const user = auth.currentUser;
            const snapshot = await get(ref(db, 'users/' + user.uid));
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('editName').value = data.fullName || "";
                document.getElementById('editEmail').value = data.email || user.email || "";
                document.getElementById('editAge').value = data.age !== "N/A" ? data.age : "";
                document.getElementById('editBirthdate').value = data.birthdate !== "N/A" ? data.birthdate : "";
                document.getElementById('editGender').value = data.gender || "MALE";
                document.getElementById('editBirthplace').value = data.birthplace !== "N/A" ? data.birthplace : "";
                document.getElementById('editAddress').value = data.currentAddress !== "N/A" ? data.currentAddress : "";
                document.getElementById('editNationality').value = data.nationality !== "N/A" ? data.nationality : "";
                document.getElementById('editStatus').value = data.status || "SINGLE";
                document.getElementById('edit-preview').src = data.profilePic || "avatar.png";
                document.getElementById('editProfileModal').style.display = 'flex';
            }
        };

                  window.saveProfile = async () => {
                const user = auth.currentUser;
                const saveBtn = document.getElementById('saveBtn');
                
                // UI Feedback
                saveBtn.innerText = "Saving...";
                saveBtn.disabled = true;
            
                // Get the Base64 string from the preview element
                const photoBase64 = document.getElementById('edit-preview').src;
            
                try {
                    const updatedData = {
                        fullName: document.getElementById('editName').value,
                        email: document.getElementById('editEmail').value,
                        age: document.getElementById('editAge').value || "N/A",
                        birthdate: document.getElementById('editBirthdate').value || "N/A",
                        gender: document.getElementById('editGender').value,
                        birthplace: document.getElementById('editBirthplace').value || "N/A",
                        currentAddress: document.getElementById('editAddress').value || "N/A",
                        nationality: document.getElementById('editNationality').value || "N/A",
                        status: document.getElementById('editStatus').value,
                        profilePic: photoBase64 // This is now the Base64 string
                    };
            
                    // Save directly to Realtime Database (Free)
                    await update(ref(db, 'users/' + user.uid), updatedData);
                    
                    alert("✅ Profile Updated Successfully!");
                    location.reload();
                } catch (error) {
                    console.error(error);
                    alert("❌ Error: " + error.message);
                    saveBtn.innerText = "Save Changes";
                    saveBtn.disabled = false;
                }
            };

        window.closeEditModal = () => document.getElementById('editProfileModal').style.display = 'none';

        // ... Student modal logic stays the same ...
        window.openModal = () => document.getElementById('studentModal').style.display = 'flex';
        window.clearForm = () => { document.getElementById('studentModal').style.display = 'none'; };
        document.getElementById('logoutBtn').addEventListener('click', () => { signOut(auth).then(() => window.location.href = 'index.html'); });
    </script>
</html>



























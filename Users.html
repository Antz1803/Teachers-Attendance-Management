<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/Dashboard.css">
    <link rel="stylesheet" href="StyleSheet/Users.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
    <style>
        /* Toast Notification - Upper Right */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { 
            padding: 12px 20px; border-radius: 8px; color: #fff; margin-bottom: 10px;
            display: flex; align-items: center; gap: 10px; font-family: sans-serif;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideIn 0.3s forwards;
        }
        .success { background: #008080; }
        .error { background: #e74c3c; }
        .info { background: #3498db; }

        /* Custom Logout Modal */
        .logout-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); 
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 15px;
            width: 350px; text-align: center; box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        .modal-btns { display: flex; gap: 15px; margin-top: 20px; }
        
        .btn-confirm { 
            background: #e74c3c; color: white; flex: 1; padding: 12px; border: none; 
            border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s;
        }
        .btn-confirm:hover { background: #c0392b; animation: shake 0.5s ease; }
        .btn-cancel { background: #f0f0f0; flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(-20px); } }
    </style>
</head>
<body style="display: flex; margin: 0;"> 
    
    <div id="toast-container"></div>

    <div id="sidebar-placeholder"></div>
    
    <div class="main-content">
        <header class="top-header">
            <h1>Users</h1>       
        </header>

        <div class="controls-row">
            <button class="btn-add-student" onclick="openModal()">+ Student</button>
        </div>

        <h3 class="admin-label">Hello! <span id="display-admin-name">Loading...</span></h3>

        <div class="profile-card">
            <div class="card-content">
                <h2 class="card-title">Teacher's Profile</h2>
                <div class="profile-details">
                    <div class="detail-item"><strong>Name:</strong> <u id="display-name">Loading...</u></div>
                    <div class="detail-item"><strong>Age:</strong> <u id="display-age">Loading...</u></div>
                    <div class="detail-item"><strong>Birthdate:</strong> <u id="display-birthdate">Loading...</u></div>
                    <div class="detail-item"><strong>Gender:</strong> <span id="display-gender">Loading...</span></div>
                    <div class="detail-item"><strong>Email:</strong> <u id="display-email">Loading...</u></div>
                    <div class="detail-item"><strong>Birthplace:</strong> <u id="display-birthplace">Loading...</u></div>
                    <div class="detail-item"><strong>Current Address:</strong> <u id="display-address">Loading...</u></div>
                    <div class="detail-item"><strong>Nationality:</strong> <u id="display-nationality">Loading...</u></div>
                    <div class="detail-item"><strong>Status:</strong> <span id="display-status">Loading...</span></div>
                </div>
            </div>
            
            <div class="photo-column">
                <div class="profile-photo-container">
                    <img src="avatar.png" id="display-photo" alt="Profile Photo">
                </div>
                <button class="btn-edit-profile" onclick="openEditModal()">âœŽ Edit profile</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getDatabase, ref, push, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
            authDomain: "attendancesystem-cb683.firebaseapp.com",
            databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
            projectId: "attendancesystem-cb683",
            storageBucket: "attendancesystem-cb683.appspot.com",
            messagingSenderId: "975901701661",
            appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- TOAST NOTIFICATION ---
        function notify(message, type = "info") {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = "fadeOut 0.5s forwards";
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        // --- SIDEBAR LOADER ---
        async function loadSidebar() {
            try {
                const response = await fetch('SideBar.html');
                const html = await response.text();
                document.getElementById('sidebar-placeholder').innerHTML = html;

                const currentPage = window.location.pathname.split("/").pop() || "index.html";
                document.querySelectorAll('.nav-links li').forEach(li => li.classList.remove('active'));
                document.querySelectorAll('.nav-links a').forEach(link => {
                    if (link.getAttribute('href') === currentPage) link.parentElement.classList.add('active');
                });

                document.getElementById('logoutBtn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('logoutModal').style.display = 'flex';
                });
            } catch (error) { console.error("Sidebar Error:", error); }
        }

        // --- LOGOUT LOGIC (FIXED) ---
        document.getElementById('confirmLogout').addEventListener('click', () => {
            document.getElementById('logoutModal').style.display = 'none';
            notify("Logging out... Redirecting", "info");
            
            setTimeout(() => {
                signOut(auth).then(() => {
                    window.location.href = 'index.html';
                }).catch(err => notify(err.message, "error"));
            }, 1000); 
        });

        // --- AUTH OBSERVER ---
        function startAuthObserver() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    onValue(ref(db, 'users/' + user.uid), (snapshot) => {
                        if (snapshot.exists()) {
                            const data = snapshot.val();
                            document.getElementById('display-admin-name').innerText = data.fullName || "Admin";
                            document.getElementById('display-name').innerText = data.fullName || "N/A";
                            document.getElementById('display-email').innerText = data.email || user.email;
                            // ... map other fields here ...
                            if (data.profilePic) document.getElementById('display-photo').src = data.profilePic;
                        }
                    });
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // --- INIT ---
        async function init() {
            await loadSidebar();
            startAuthObserver();
        }
        init();

        // Global Window Functions
        window.closeLogoutModal = () => document.getElementById('logoutModal').style.display = 'none';
        window.openModal = () => document.getElementById('studentModal').style.display = 'flex';
        window.closeEditModal = () => document.getElementById('editProfileModal').style.display = 'none';
    </script>
</body>
</html>

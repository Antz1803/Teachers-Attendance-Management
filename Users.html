<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users - Attendance System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="StyleSheet/Dashboard.css"> 
    <link rel="stylesheet" href="StyleSheet/Users.css">
    <link rel="stylesheet" href="StyleSheet/SideBar.css">
</head>
<body style="display: flex; margin: 0;"> <div class="sidebar">
        <div class="sidebar-header">
            <div class="profile-container">
                <div class="profile-circle">
                    <i class="fas fa-user-tie"></i> 
                </div>
                <div class="profile-info">
                    <h3>Admin</h3>
                    <span>Authorized</span>
                </div>
            </div>
        </div>

        <ul class="nav-links">
            <li class="nav-item">
                <a href="Dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a>
            </li>
            <li class="nav-item active"> 
                <a href="Users.html"><i class="fas fa-users"></i> Users</a>
            </li>
            <li class="nav-item">
                <a href="Courses.html"><i class="fas fa-book"></i> Courses</a>
            </li>
            <li class="nav-item">
                <a href="Settings.html"><i class="fas fa-cog"></i> Settings</a>
            </li>
        </ul>

        <div class="sidebar-footer">
            <li class="nav-item logout">
                <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
        </div>
    </div>
    
      <div class="main-content">
        <header class="top-header">
            <h1>Users</h1>       
        </header>

        <div class="controls-row">
            <button class="btn-add-student" onclick="openModal()">+ Student</button>
        </div>

     <h3 class="admin-label">Hello! <span id="display-admin-name">Loading...</span></h3>


<div class="profile-card">
    <div class="card-content">
        <h2 class="card-title">Teacher's Profile</h2>
        <div class="profile-details">
            <div class="detail-item"><strong>Name:</strong> <u id="display-name">Loading...</u></div>
            <div class="detail-item"><strong>Age:</strong> <u id="display-age">Loading...</u></div>
            <div class="detail-item"><strong>Birthdate:</strong> <u id="display-birthdate">Loading...</u></div>
            <div class="detail-item"><strong>Gender:</strong> <span id="display-gender">Loading...</span></div>
            <div class="detail-item"><strong>Email:</strong> <u id="display-email">Loading...</u></div>
            <div class="detail-item"><strong>Birthplace:</strong> <u id="display-birthplace">Loading...</u></div>
            <div class="detail-item"><strong>Current Address:</strong> <u id="display-address">Loading...</u></div>
            <div class="detail-item"><strong>Nationality:</strong> <u id="display-nationality">Loading...</u></div>
            <div class="detail-item"><strong>Status:</strong> <span id="display-status">Loading...</span></div>
        </div>
    </div>
    
    <div class="photo-column">
        <div class="profile-photo-container">
            <img src="avatar.png" id="display-photo" alt="Profile Photo">
        </div>
        <button class="btn-edit-profile" onclick="openEditModal()">✎ Edit profile</button>
    </div>
</div>

<div id="editProfileModal" class="modal-overlay" style="display: none;">
    <div class="modal-card">
       <div class="modal-body">
            <h3 class="full-width">Update Teacher Profile</h3>
            <div class="file-input-wrapper">
                <img id="edit-preview" src="avatar.png" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd;">
                <label for="editPhoto" class="btn-upload">Choose New Photo</label>
                <input type="file" id="editPhoto" accept="image/*" onchange="previewImage(event)">
            </div>
            <div class="modal-grid">
                <div class="modal-form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName">
                </div>
                <div class="modal-form-group">
                    <label>Email Address</label>
                    <input type="email" id="editEmail">
                </div>
               <div class="modal-form-group">
                    <label>Age</label>
                    <input type="text" id="editAge" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
                </div>
                <div class="modal-form-group">
                    <label>Birthdate</label>
                    <input type="date" id="editBirthdate">
                </div>
                <div class="modal-form-group">
                    <label>Gender</label>
                    <select id="editGender">
                        <option value="MALE">MALE</option>
                        <option value="FEMALE">FEMALE</option>
                        <option value="OTHER">OTHER</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="SINGLE">SINGLE</option>
                        <option value="MARRIED">MARRIED</option>
                        <option value="WIDOWED">WIDOWED</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label>Birthplace</label>
                    <input type="text" id="editBirthplace">
                </div>
                <div class="modal-form-group">
                    <label>Nationality</label>
                    <input type="text" id="editNationality">
                </div>
                <div class="modal-form-group full-width">
                    <label>Current Address</label>
                    <input type="text" id="editAddress">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-submit" id="saveBtn" onclick="saveProfile()">Save Changes</button>
                <button class="btn-clear" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
</div>
    
    <div id="studentModal" class="modal-overlay" style="display: none;">
        <div class="modal-card">
            <div class="modal-header"></div>
            <div class="modal-body">
                <h3>New Student Details</h3>
                
                <div class="modal-form-group">
                    <label>Full Name</label>
                    <input type="text" id="stuName" placeholder="Please enter your fullname">
                    <small id="error-name" class="error-msg" style="color: red; display: none;">❌ This name is already registered.</small>
                </div>

                <div class="modal-form-group">
                    <label>Email</label>
                    <input type="email" id="stuEmail" placeholder="Please enter your email">
                    <small id="error-email" class="error-msg">❌ Email must end with @gmail.com</small>
                </div>

               <div class="modal-form-group">
                    <label>Student ID</label>
                    <input type="text" id="stuID" placeholder="Numbers & symbols only" maxlength="10">
                    <small id="error-id" class="error-msg">❌ This Student ID is already registered.</small>
                </div>
                
                <div class="modal-form-group">
                    <label>Course</label>
                    <input type="text" id="stuCourse" placeholder="e.g. PLATECH" oninput="this.value = this.value.toUpperCase()">
                </div>

                <div class="modal-form-group" style="margin-bottom: 15px;">
                    <label>Year lvl</label>
                    <select id="stuYear" style="padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                        <option value="" disabled selected>Select Year Level</option>
                        <option value="1st Year">1st Year</option>
                        <option value="2nd Year">2nd Year</option>
                        <option value="3rd Year">3rd Year</option>
                        <option value="4th Year">4th Year</option>
                    </select>
                </div>

                <div class="modal-form-group">
                    <label>Section</label>
                    <input type="text" id="stuSection" placeholder="e.g. IT803A">
                </div>

                <div class="modal-footer">
                    <button class="btn-submit" onclick="submitStudent()">Submit</button>
                    <button class="btn-clear" onclick="clearForm()">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getDatabase, ref, push, get, query, orderByChild, equalTo, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    const firebaseConfig = {
        apiKey: "AIzaSyCSADfQpAWpCbB8Idf3Eu94kMeO-7QX4aQ",
        authDomain: "attendancesystem-cb683.firebaseapp.com",
        databaseURL: "https://attendancesystem-cb683-default-rtdb.firebaseio.com",
        projectId: "attendancesystem-cb683",
        storageBucket: "attendancesystem-cb683.appspot.com",
        messagingSenderId: "975901701661",
        appId: "1:975901701661:web:f8ccfbafd8e6c6e9c3f8f4"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // --- FUNCTION: Calculate Age Based on Birthdate String ---
    function calculateAge(birthdateString) {
        if (!birthdateString || birthdateString === "N/A") return "";
        const today = new Date();
        const birthDate = new Date(birthdateString);
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age >= 0 ? age : 0;
    }

    // --- FUNCTION: Preview Selected Profile Image ---
    window.previewImage = (event) => {
        const reader = new FileReader();
        reader.onload = () => { document.getElementById('edit-preview').src = reader.result; };
        if(event.target.files[0]) reader.readAsDataURL(event.target.files[0]);
    };

    // --- AUTH OBSERVER: Monitor Login State and Load Dashboard Data ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snapshot = await get(ref(db, 'users/' + user.uid));
            if (snapshot.exists()) {
                const data = snapshot.val();
                document.getElementById('display-admin-name').innerText = data.fullName || "Admin";
                document.getElementById('display-name').innerText = data.fullName || "N/A";
                document.getElementById('display-age').innerText = data.age || "N/A";
                document.getElementById('display-birthdate').innerText = data.birthdate || "N/A";
                document.getElementById('display-gender').innerText = data.gender || "N/A";
                document.getElementById('display-email').innerText = data.email || user.email;
                document.getElementById('display-birthplace').innerText = data.birthplace || "N/A";
                document.getElementById('display-address').innerText = data.currentAddress || "N/A";
                document.getElementById('display-nationality').innerText = data.nationality || "N/A";
                document.getElementById('display-status').innerText = data.status || "N/A";
                if (data.profilePic) document.getElementById('display-photo').src = data.profilePic;
            }
        } else { window.location.href = 'index.html'; }
    });

    // --- FUNCTION: Open Teacher Edit Modal and Populate Fields ---
    window.openEditModal = async () => {
        const user = auth.currentUser;
        const snapshot = await get(ref(db, 'users/' + user.uid));
        if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById('editName').value = data.fullName || "";
            document.getElementById('editEmail').value = data.email || user.email || "";
            document.getElementById('editBirthdate').value = data.birthdate !== "N/A" ? data.birthdate : "";
            document.getElementById('editGender').value = data.gender || "MALE";
            document.getElementById('editBirthplace').value = data.birthplace !== "N/A" ? data.birthplace : "";
            document.getElementById('editAddress').value = data.currentAddress !== "N/A" ? data.currentAddress : "";
            document.getElementById('editNationality').value = data.nationality !== "N/A" ? data.nationality : "";
            document.getElementById('editStatus').value = data.status || "SINGLE";
            document.getElementById('edit-preview').src = data.profilePic || "avatar.png";
            
            // Set initial age calculation
            document.getElementById('editAge').value = calculateAge(data.birthdate);
            
            document.getElementById('editProfileModal').style.display = 'flex';
        }
    };

    // --- EVENT LISTENER: Auto-Update Age when Birthdate changes ---
    document.getElementById('editBirthdate').addEventListener('change', (e) => {
        document.getElementById('editAge').value = calculateAge(e.target.value);
    });

    // --- FUNCTION: Save Updated Profile Data to Firebase ---
    window.saveProfile = async () => {
        const user = auth.currentUser;
        const saveBtn = document.getElementById('saveBtn');
        
        saveBtn.innerText = "Saving...";
        saveBtn.disabled = true;
        const photoBase64 = document.getElementById('edit-preview').src;
    
        try {
            const updatedData = {
                fullName: document.getElementById('editName').value,
                email: document.getElementById('editEmail').value,
                age: document.getElementById('editAge').value || "N/A",
                birthdate: document.getElementById('editBirthdate').value || "N/A",
                gender: document.getElementById('editGender').value,
                birthplace: document.getElementById('editBirthplace').value || "N/A",
                currentAddress: document.getElementById('editAddress').value || "N/A",
                nationality: document.getElementById('editNationality').value || "N/A",
                status: document.getElementById('editStatus').value,
                profilePic: photoBase64 
            };
    
            await update(ref(db, 'users/' + user.uid), updatedData);
            alert("✅ Profile Updated Successfully!");
            location.reload();
        } catch (error) {
            console.error(error);
            alert("❌ Error: " + error.message);
            saveBtn.innerText = "Save Changes";
            saveBtn.disabled = false;
        }
    };

 // --- EVENT LISTENER: Restrict Student ID to Numbers and Symbols Only ---
document.getElementById('stuID').addEventListener('input', function(e) {
    // Keeps numbers (0-9) and symbols (like -, #, etc.)
    this.value = this.value.replace(/[a-zA-Z]/g, '');
});

// --- FUNCTION: Submit New Student to Firebase (Updated Version) ---
window.submitStudent = async () => {
    const name = document.getElementById('stuName').value.trim();
    const email = document.getElementById('stuEmail').value.trim();
    const id = document.getElementById('stuID').value.trim();
    const course = document.getElementById('stuCourse').value.trim().toUpperCase(); 
    const year = document.getElementById('stuYear').value;
    const section = document.getElementById('stuSection').value.trim();

    // Reset error displays
    document.getElementById('error-email').style.display = 'none';
    document.getElementById('error-id').style.display = 'none';
    document.getElementById('error-name').style.display = 'none';

    if (!name || !email || !id || !course || !year || !section) {
        alert("Please fill in all fields.");
        return;
    }

    if (!email.toLowerCase().endsWith('@gmail.com')) {
        document.getElementById('error-email').style.display = 'block';
        return;
    }

    try {
        const studentsRef = ref(db, 'students');
        const snapshot = await get(studentsRef);
        
        if (snapshot.exists()) {
            const existingData = snapshot.val();
            for (let key in existingData) {
                if (existingData[key].studentID === id) {
                    document.getElementById('error-id').style.display = 'block';
                    return;
                }
                const existingName = existingData[key].name || "";
                if (existingName.toLowerCase() === name.toLowerCase()) {
                    document.getElementById('error-name').style.display = 'block';
                    return;
                }
            }
        }

        const newStudentRef = push(ref(db, 'students'));
        await update(newStudentRef, {
            name: name,
            email: email,
            studentID: id,
            stuCourses: course, 
            yearLevel: year,
            section: section,
            createdAt: new Date().toISOString()
        });

        alert("✅ Student Registered Successfully!");
        window.clearForm();
        location.reload();

    } catch (error) {
        console.error("Submission Error:", error);
        alert("❌ Error: " + error.message);
    }
};
    
    // --- FUNCTION: Close Edit Profile Modal ---
    window.closeEditModal = () => document.getElementById('editProfileModal').style.display = 'none';

    // --- FUNCTION: Open Student Registration Modal ---
    window.openModal = () => document.getElementById('studentModal').style.display = 'flex';

    // --- FUNCTION: Close/Clear Student Modal ---
    window.clearForm = () => { document.getElementById('studentModal').style.display = 'none'; };

    // --- EVENT LISTENER: Logout from System ---
    document.getElementById('logoutBtn').addEventListener('click', () => { 
        signOut(auth).then(() => window.location.href = 'index.html'); 
    });
</script>
</html>

































